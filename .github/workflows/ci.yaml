name: test-build-scan

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build the image from the Dockerfile in the repo root
      # Tag it immutably with the commit SHA and also as :ci for convenience
      - name: Build image (no cache)
        run: |
          docker build --no-cache -t openshift-helm-nodejs:${{ github.sha }} .
          docker tag openshift-helm-nodejs:${{ github.sha }} openshift-helm-nodejs:ci

      # Sanity check what we actually built (Node + Alpine)
      - name: Show runtime versions (sanity check)
        run: |
          echo "Image tags:"
          docker image inspect openshift-helm-nodejs:${{ github.sha }} --format '{{json .RepoTags}}'
          echo "Node version:"
          docker run --rm openshift-helm-nodejs:${{ github.sha }} node -v
          echo "Alpine release (if alpine-based):"
          docker run --rm openshift-helm-nodejs:${{ github.sha }} sh -lc 'cat /etc/alpine-release || true'

      # Trivy scan the IMMUTABLE tag (no chance we scanned an old :ci)
      - name: Trivy scan (CRITICAL,HIGH)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: openshift-helm-nodejs:${{ github.sha }}
          format: table
          exit-code: "1"
          severity: "CRITICAL,HIGH"
          scan-type: image
          ignore-unfixed: false
          vuln-type: "os,library"
